@using WebUI.Components.Models
@using Application.Service.Queries
@using Application.Service.Commands
@using Application.DTO.Request
@using Application.DTO.Response
@using WebUI.Utilities
<MudDialog>
    <TitleContent>
        Create Zone
    </TitleContent>
    <DialogContent>
        <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
            <MudSelect @bind-Value="_zoneModel.WarehouseId"
                       T="Guid"
                       ToStringFunc="@_convertWarehouseIdToString"
                       Variant="@_defaultVariant"
                       Label="Zone Group"
                       Margin="Margin.Normal"
                       Dense="false"
                       Disabled="false"
                       ReadOnly="false"
                       Placeholder=@("Warehouse")
                       MultiSelection="false"
                       HelperText=@("Please select a warehouse group")
                       HelperTextOnFocus="true"
                       Clearable="false"
                       Required="true"
                       RequiredError="Please select a warehouse">
                @foreach (var warehouse in _warehouses)
                {
                    <MudSelectItem Value="@warehouse.Id" />
                }
            </MudSelect>

            <MudTextField @bind-value="_zoneModel.Name"
                          Variant="@_defaultVariant"
                          T="string"
                          Label="Name"
                          Required="true" RequiredError="Name is required!"
                          Margin="Margin.Dense" />

        </MudForm>
        </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(!_isFormValid)">Ok</MudButton>
    </DialogActions>
</MudDialog>
@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; }
    private static readonly Variant _defaultVariant = Theme.DefaultInputVariant();

    private bool _isFormValid { get; set; } = false;
    private MudForm _form;

    private ZoneModel _zoneModel { get; set; } = new ZoneModel();
    private static List<WarehouseModel> _warehouses = new List<WarehouseModel>();
    private GetStaffResponseDTO _getStaffResponseDTO { get; set; }

    private async Task Submit()
    {
        var createZoneDTO = new CreateZoneRequestDTO()
        {
            CreatedBy = _getStaffResponseDTO.CreatedBy,
            Name = _zoneModel.Name,
            WarehouseId = _zoneModel.WarehouseId,
        };
        var createZoneCommand = new CreateZoneCommand(createZoneDTO);
        var createdZoneResponseDTO = await Mediator.Send(createZoneCommand);
        SnackBar.Add($"{_zoneModel.Name} created");

        var createdZoneModel = new ZoneModel()
        {
            Id = createdZoneResponseDTO.Id,
            Name = _zoneModel.Name,
            WarehouseId = _zoneModel.WarehouseId,
        };
        MudDialog.Close(DialogResult.Ok(createdZoneModel));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private readonly Func<Guid, string> _convertWarehouseIdToString = 
        warehouseId =>
        {
            var _warehouse = _warehouses.FirstOrDefault(group => group.Id == warehouseId);
            return $"{_warehouse?.Name}";
        };

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _getStaffResponseDTO = await UserUtilities.GetCurrentUser(Mediator, AuthenticationStateProvider);

        var getAllWarehouseByCompanyId = new GetAllWarehouseByCompanyIdQuery(_getStaffResponseDTO.CompanyId);
        var allWarehouseDTO = await Mediator.Send(getAllWarehouseByCompanyId);

        foreach (var warehouseDTO in allWarehouseDTO)
        {
            var warehouseModel = new WarehouseModel()
            {
                Id = warehouseDTO.Id,
                Name = warehouseDTO.Name,
                Address = warehouseDTO.Address,
                CompanyId = warehouseDTO.CompanyId,
            };

            _warehouses.Add(warehouseModel);
        }
    }
}